{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/PC/Desktop/Our_Stocks_Project/apps/web/src/app/api/products/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { drizzle } from 'drizzle-orm/neon-http';\nimport { neon } from '@neondatabase/serverless';\nimport { pgTable, serial, text, integer, timestamp, varchar } from 'drizzle-orm/pg-core';\nimport { desc, eq } from 'drizzle-orm';\n\n// Schema products\nconst products = pgTable('products', {\n  id: serial('id').primaryKey(),\n  name: text('name').notNull(),\n  sku: text('sku').notNull(),\n  quantity: integer('quantity').default(0).notNull(),\n  price: integer('price'),\n  category_id: integer('category_id'),\n  supplier: text('supplier'),\n  low_stock_threshold: integer('low_stock_threshold').default(10),\n  updated_at: timestamp('updated_at').defaultNow(),\n  created_at: timestamp('created_at').defaultNow(),\n});\n\n// Schema categories\nconst categories = pgTable('categories', {\n  id: serial('id').primaryKey(),\n  name: varchar('name', { length: 255 }).notNull(),\n  description: text('description'),\n  color: varchar('color', { length: 7 }),\n  created_at: timestamp('created_at').defaultNow(),\n  updated_at: timestamp('updated_at').defaultNow(),\n});\n\nconst sql = neon(process.env.DATABASE_URL!);\nconst db = drizzle(sql);\n\nexport const dynamic = 'force-dynamic';\n\n// GET - Liste tous les produits\nexport async function GET() {\n  try {\n    const allProducts = await db\n      .select({\n        id: products.id,\n        name: products.name,\n        sku: products.sku,\n        quantity: products.quantity,\n        price: products.price,\n        category_id: products.category_id,\n        category_name: categories.name,\n        supplier: products.supplier,\n        low_stock_threshold: products.low_stock_threshold,\n        created_at: products.created_at\n      })\n      .from(products)\n      .leftJoin(categories, eq(products.category_id, categories.id))\n      .orderBy(desc(products.id));\n\n    return NextResponse.json({\n      success: true,\n      data: allProducts,\n    });\n  } catch (error: any) {\n    console.error('Error fetching products:', error);\n    return NextResponse.json(\n      { success: false, error: error.message },\n      { status: 500 }\n    );\n  }\n}\n\n// POST - Créer un nouveau produit\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { name, sku, quantity, price, categoryId, supplier, lowStockThreshold } = body;\n\n    // Validation des champs requis\n    if (!name || !sku) {\n      return NextResponse.json(\n        { success: false, error: 'Name and SKU are required' },\n        { status: 400 }\n      );\n    }\n\n    // Validation du SKU (optionnel - format)\n    if (sku.trim().length < 3) {\n      return NextResponse.json(\n        { success: false, error: 'SKU must be at least 3 characters' },\n        { status: 400 }\n      );\n    }\n\n    // Créer le produit\n    const [newProduct] = await db\n      .insert(products)\n      .values({ \n        name: name.trim(), \n        sku: sku.trim().toUpperCase(), // Convertir en majuscules pour cohérence\n        quantity: quantity || 0,\n        price: price ? Math.round(price * 100) : null, // Convertir en cents\n        category_id: categoryId || null,\n        supplier: supplier ? supplier.trim() : null,\n        low_stock_threshold: lowStockThreshold || 10\n      })\n      .returning();\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        ...newProduct,\n        price: newProduct.price ? newProduct.price / 100 : null // Convertir en dollars\n      },\n      message: 'Product created successfully',\n    });\n  } catch (error: any) {\n    console.error('Error creating product:', error);\n    \n    // Gestion spécifique pour les erreurs de contrainte unique (SKU dupliqué)\n    if (error.code === '23505') {\n      if (error.constraint === 'products_sku_key') {\n        return NextResponse.json(\n          { \n            success: false, \n            error: 'This SKU already exists. Please use a different SKU.',\n            field: 'sku'\n          },\n          { status: 409 }\n        );\n      }\n    }\n    \n    // Autres erreurs\n    return NextResponse.json(\n      { success: false, error: error.message || 'Failed to create product' },\n      { status: 500 }\n    );\n  }\n}"],"names":[],"mappings":"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"}}]
}