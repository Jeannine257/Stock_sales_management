{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/PC/Desktop/Our_Stocks_Project/apps/web/src/app/api/notifications/low-stock/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { drizzle } from 'drizzle-orm/neon-http';\nimport { neon } from '@neondatabase/serverless';\nimport { pgTable, serial, text, integer, timestamp, varchar } from 'drizzle-orm/pg-core';\nimport { and, lt, isNotNull, eq } from 'drizzle-orm';\n\n// Schema products\nconst products = pgTable('products', {\n  id: serial('id').primaryKey(),\n  name: text('name').notNull(),\n  sku: text('sku').notNull(),\n  quantity: integer('quantity').default(0).notNull(),\n  price: integer('price'),\n  category_id: integer('category_id'),\n  supplier: text('supplier'),\n  low_stock_threshold: integer('low_stock_threshold').default(10),\n  updated_at: timestamp('updated_at').defaultNow(),\n  created_at: timestamp('created_at').defaultNow(),\n});\n\n// Schema categories\nconst categories = pgTable('categories', {\n  id: serial('id').primaryKey(),\n  name: varchar('name', { length: 255 }).notNull(),\n  description: text('description'),\n  color: varchar('color', { length: 7 }),\n  created_at: timestamp('created_at').defaultNow(),\n  updated_at: timestamp('updated_at').defaultNow(),\n});\n\nconst sql = neon(process.env.DATABASE_URL!);\nconst db = drizzle(sql);\n\nexport const dynamic = 'force-dynamic';\n\n// GET - Récupérer les alertes de stock bas\nexport async function GET() {\n  try {\n    // Récupérer les produits avec stock bas\n    const lowStockProducts = await db\n      .select({\n        id: products.id,\n        name: products.name,\n        sku: products.sku,\n        quantity: products.quantity,\n        low_stock_threshold: products.low_stock_threshold,\n        supplier: products.supplier,\n        category_name: categories.name,\n        category_color: categories.color\n      })\n      .from(products)\n      .leftJoin(categories, eq(products.category_id, categories.id))\n      .where(\n        and(\n          isNotNull(products.low_stock_threshold),\n          lt(products.quantity, products.low_stock_threshold)\n        )\n      )\n      .orderBy(products.quantity);\n\n    // Calculer le nombre total d'alertes\n    const totalAlerts = lowStockProducts.length;\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        alerts: lowStockProducts,\n        total: totalAlerts,\n        message: totalAlerts > 0 \n          ? `Vous avez ${totalAlerts} produit(s) avec un stock bas`\n          : 'Aucune alerte de stock bas'\n      },\n    });\n  } catch (error: any) {\n    console.error('Error fetching low stock alerts:', error);\n    return NextResponse.json(\n      { success: false, error: error.message },\n      { status: 500 }\n    );\n  }\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;;;;;;AAEA,kBAAkB;AAClB,MAAM,WAAW,IAAA,2QAAO,EAAC,YAAY;IACnC,IAAI,IAAA,sRAAM,EAAC,MAAM,UAAU;IAC3B,MAAM,IAAA,kRAAI,EAAC,QAAQ,OAAO;IAC1B,KAAK,IAAA,kRAAI,EAAC,OAAO,OAAO;IACxB,UAAU,IAAA,wRAAO,EAAC,YAAY,OAAO,CAAC,GAAG,OAAO;IAChD,OAAO,IAAA,wRAAO,EAAC;IACf,aAAa,IAAA,wRAAO,EAAC;IACrB,UAAU,IAAA,kRAAI,EAAC;IACf,qBAAqB,IAAA,wRAAO,EAAC,uBAAuB,OAAO,CAAC;IAC5D,YAAY,IAAA,4RAAS,EAAC,cAAc,UAAU;IAC9C,YAAY,IAAA,4RAAS,EAAC,cAAc,UAAU;AAChD;AAEA,oBAAoB;AACpB,MAAM,aAAa,IAAA,2QAAO,EAAC,cAAc;IACvC,IAAI,IAAA,sRAAM,EAAC,MAAM,UAAU;IAC3B,MAAM,IAAA,wRAAO,EAAC,QAAQ;QAAE,QAAQ;IAAI,GAAG,OAAO;IAC9C,aAAa,IAAA,kRAAI,EAAC;IAClB,OAAO,IAAA,wRAAO,EAAC,SAAS;QAAE,QAAQ;IAAE;IACpC,YAAY,IAAA,4RAAS,EAAC,cAAc,UAAU;IAC9C,YAAY,IAAA,4RAAS,EAAC,cAAc,UAAU;AAChD;AAEA,MAAM,MAAM,IAAA,yOAAI,EAAC,QAAQ,GAAG,CAAC,YAAY;AACzC,MAAM,KAAK,IAAA,8QAAO,EAAC;AAEZ,MAAM,UAAU;AAGhB,eAAe;IACpB,IAAI;QACF,wCAAwC;QACxC,MAAM,mBAAmB,MAAM,GAC5B,MAAM,CAAC;YACN,IAAI,SAAS,EAAE;YACf,MAAM,SAAS,IAAI;YACnB,KAAK,SAAS,GAAG;YACjB,UAAU,SAAS,QAAQ;YAC3B,qBAAqB,SAAS,mBAAmB;YACjD,UAAU,SAAS,QAAQ;YAC3B,eAAe,WAAW,IAAI;YAC9B,gBAAgB,WAAW,KAAK;QAClC,GACC,IAAI,CAAC,UACL,QAAQ,CAAC,YAAY,IAAA,mRAAE,EAAC,SAAS,WAAW,EAAE,WAAW,EAAE,GAC3D,KAAK,CACJ,IAAA,oRAAG,EACD,IAAA,0RAAS,EAAC,SAAS,mBAAmB,GACtC,IAAA,mRAAE,EAAC,SAAS,QAAQ,EAAE,SAAS,mBAAmB,IAGrD,OAAO,CAAC,SAAS,QAAQ;QAE5B,qCAAqC;QACrC,MAAM,cAAc,iBAAiB,MAAM;QAE3C,OAAO,+QAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;gBACJ,QAAQ;gBACR,OAAO;gBACP,SAAS,cAAc,IACnB,CAAC,UAAU,EAAE,YAAY,6BAA6B,CAAC,GACvD;YACN;QACF;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,oCAAoC;QAClD,OAAO,+QAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC,GACvC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}